substitutions:
  # EUC Settings
  euc_name: "Inmotion V11"
  euc_mac: !secret euc_inmotion_mac

esphome:
  name: esphome-euc
  friendly_name: ESPHome EUC Sensor
  includes:
    - parser_inmotionv2.h

esp32:
  board: esp32dev
  framework:
    type: esp-idf

logger:
  logs:
    light: ERROR
    component: ERROR
    status_led: ERROR
    esp32_ble_client: ERROR
    ble_sensor: ERROR
    binary_sensor: ERROR
    sensor: ERROR

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true
  ap:

api:
  encryption:
    key: !secret ha_encryption_key

ota:
  - platform: esphome
    password: !secret wifi_password

web_server:
  port: 80
  include_internal: false
  version: 3

output:
  - platform: gpio
    pin: GPIO2
    id: gpio_d2

light:
  - platform: binary
    name: EUC Connected LED
    id: status
    output: gpio_d2
    internal: true
    entity_category: "diagnostic"

esp32_ble_tracker:

ble_client:
  - mac_address: "${euc_mac}"
    id: euc
    auto_connect: true
    on_connect:
      then:
        - lambda: |-
            id(status).turn_on().perform();
            id(euc_connected).publish_state(true);
            id(ble_connect_switch).publish_state(true);
    on_disconnect:
      then:
        - lambda: |-
            id(status).turn_off().perform();
            id(euc_connected).publish_state(false);
            id(euc_charging).publish_state(false);
            id(euc_lifted).publish_state(false);
            id(euc_battery_percentage).publish_state(NAN);
            id(euc_voltage).publish_state(NAN);
            id(euc_current).publish_state(NAN);
            id(euc_power).publish_state(NAN);

binary_sensor:
  - platform: template
    id: euc_connected
    name: "${euc_name} Connected"
    icon: mdi:bluetooth
    device_class: connectivity

  - platform: template
    id: euc_charging
    name: "${euc_name} Charging"
    icon: mdi:power-plug-battery
    device_class: battery_charging

  - platform: gpio
    pin:
      number: GPIO0
      inverted: true
      mode: INPUT_PULLUP
    name: "Boot Button"
    on_press:
      - switch.toggle: ble_connect_switch

  - platform: template
    id: euc_lifted
    name: "${euc_name} Lifted"
    icon: mdi:horizontal-rotate-counterclockwise

button:
  - platform: restart
    name: "Restart ESP32"
    entity_category: "diagnostic"

globals:
  - id: ble_buffer
    type: std::vector<uint8_t>
    initial_value: "std::vector<uint8_t>()"

  - id: expected_length
    type: int

interval:
  - interval: 1000ms
    startup_delay: 5sec
    then:
      - ble_client.ble_write:
          id: euc
          service_uuid: "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
          characteristic_uuid: "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
          value: [0xAA, 0xAA, 0x14, 0x01, 0x04, 0x11]

sensor:
  - platform: ble_client
    id: states
    internal: true
    entity_category: diagnostic
    ble_client_id: euc
    type: characteristic
    notify: true
    service_uuid: "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
    characteristic_uuid: "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"
    lambda: |-
      parse_inmotionv2_packet(x);
      return {};

  - platform: template
    id: euc_voltage
    name: "${euc_name} Voltage"
    icon: mdi:flash
    device_class: voltage
    state_class: measurement
    unit_of_measurement: "V"
    accuracy_decimals: 2

  - platform: template
    id: euc_battery_percentage
    name: "${euc_name} Battery"
    icon: mdi:battery
    device_class: battery
    state_class: measurement
    unit_of_measurement: "%"
    accuracy_decimals: 2

  - platform: template
    id: euc_current
    name: "${euc_name} Current"
    icon: mdi:current-ac
    device_class: current
    state_class: measurement
    unit_of_measurement: "A"
    accuracy_decimals: 2

  - platform: template
    id: euc_power
    name: "${euc_name} Power"
    icon: mdi:flash
    device_class: power
    state_class: measurement
    unit_of_measurement: "W"
    accuracy_decimals: 2

switch:
  - platform: template
    name: "BLE connect"
    id: ble_connect_switch
    icon: mdi:bluetooth
    optimistic: true
    entity_category: "diagnostic"
    restore_mode: DISABLED
    on_turn_on:
      - ble_client.connect: euc
    on_turn_off:
      - ble_client.disconnect: euc

text_sensor:
  - platform: template
    id: euc_firmware_version
    entity_category: "diagnostic"
    name: "${euc_name} firmwareVersion"
    icon: mdi:cellphone-arrow-down
